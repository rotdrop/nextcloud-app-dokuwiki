/*! For license information please see src_DokuWikiWrapper_vue-6099b62788c1d330460b.js.LICENSE.txt */
"use strict";(self.webpackChunk_rotdrop_nextcloud_app_dokuwiki=self.webpackChunk_rotdrop_nextcloud_app_dokuwiki||[]).push([["src_DokuWikiWrapper_vue"],{4037:(e,r,t)=>{t.r(r),t.d(r,{default:()=>f});var a=t(5471),o=t(1827),l=t(3334),i=t(5168);const n=async e=>{let{title:r,text:t}=e;await(0,i.As)(r).setText(t).setSeverity(i.aR.Info).addButton({label:(0,l.Tl)("core","Yes"),type:"primary",callback(){}}).build().show()},c=e=>{const r=e?.contentWindow?.document;r&&(r.querySelectorAll("#dokuwiki__header div.pad").forEach((e=>e.remove())),r.querySelectorAll("#dokuwiki_header").forEach((e=>{e.style.padding="2.5em 0px 0px"})),r.querySelectorAll("#dokuwiki__footer").forEach((e=>e.remove())))};var u=t(2981);const s=function(){let{section:e,defaults:r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{section:"config"};try{return(0,u.C)(o.J,e)}catch(t){return r||null===r?r:(console.error('error in loadState("'+e+'"): ',t),null)}};var d=t(8742);const p=(0,a.pM)({__name:"DokuWikiWrapper",props:{fullScreen:{type:Boolean,default:!0},iFrameAttributes:{default:()=>({})},query:{default:()=>({})},wikiPage:{default:""}},emits:["iframe-loaded","iframe-resize","update-loading","error"],setup(e,r){let{expose:t,emit:i}=r;const u=e,p="DokuWiki",f=new d.A(p+"Wrapper"),m=s(),v=(0,a.KR)(!0);(0,a.wB)(v,(e=>i("update-loading",e)));const h=(0,a.EW)((()=>{const e=new URLSearchParams({id:u.wikiPage,...u.query}).toString().replace("%3A",":");return m?.wikiURL+"/doku.php?"+e})),w=(0,a.KR)(h.value),k=(0,a.KR)(h.value),g=(0,a.EW)((()=>o.J+"-frame"));(0,a.wB)((()=>u.wikiPage),(()=>{h.value!==k.value?(f.debug("TRIGGER IFRAME REFRESH",{request:h.value,current:k.value}),v.value=!0,w.value=h.value):f.debug("NOT CHANGING IFRAME SOURCE",{request:h.value,current:k.value})}));const E=1e3;let A,y=0;const S=(0,a.KR)(null),b=(0,a.KR)(null),_=(0,a.KR)(null),R=(0,a.KR)(null);let T;const F=e=>{let{width:r,height:t}=e;if(!R.value)return;const a=R.value;a.style.width=r+"px",a.style.height=t+"px"},L=new ResizeObserver((e=>{for(const r of e)r.target!==T?u.fullScreen&&r.target===S.value&&F(r.contentRect):i("iframe-resize",r)})),q=e=>{b.value.classList.toggle("fading",!0),i("error",{error:e instanceof Error?e:new Error("Non-error error",{cause:e}),hint:(0,l.Tl)(o.J,"Unable to access the contents of the wrapped {wrappedApp} instance.\nThis may be caused by cross-domain access restrictions.\nPlease check that your Nextcloud instance ({nextcloudUrl}) and the wrapped {wrappedApp} instance ({iFrameUrl}) are served from the same domain.",{wrappedApp:p,nextcloudUrl:window.location.protocol+"//"+window.location.host,iFrameUrl:m?.wikiURL||""})})},x=()=>{if(A=void 0,v.value){y++;try{R.value.contentWindow.document.querySelector("#layout")?(f.debug("LOAD EVENT FROM TIMER AFTER "+E*y+" ms"),R.value.dispatchEvent(new Event("load"))):A=setTimeout(x,E)}catch(e){f.error("UNABLE TO ACCESS IFRAME CONTENTS",{error:e}),q(e)}}};return(0,a.KC)((()=>{v.value=!0,w.value=h.value})),(0,a.wB)((()=>u.fullScreen),(e=>{if(e){const e=R.value;e&&(w.value!==h.value?w.value=h.value:e.contentWindow&&(e.contentWindow.location.href=h.value))}else c(R.value||void 0)})),(0,a.sV)((()=>{A||(A=setTimeout(x,E)),L.observe(S.value)})),(0,a.xo)((()=>{L.disconnect()})),t({currentLocation:k,wikiIFrame:R}),{__sfc:!0,wrappedApp:p,logger:f,props:u,emit:i,initialState:m,loading:v,requestedLocation:h,iFrameLocation:w,currentLocation:k,frameId:g,loadTimeout:E,timerCount:y,loadTimer:A,container:S,loaderContainer:b,frameWrapper:_,externalFrame:R,iFrameBody:T,setIFrameSize:F,resizeObserver:L,emitError:q,loadHandler:()=>{f.debug("GOT LOAD EVENT");const e=R.value,r=e?.contentWindow;if(!e||!r)return;let t;v.value=!0;try{t=e.contentDocument,(e=>{const r=e?.contentWindow?.document;if(!r)return;r.querySelectorAll(".logout").forEach((e=>e.remove())),r.querySelectorAll("li:empty").forEach((e=>e.remove())),r.querySelectorAll("form.btn_logout").forEach((e=>e.remove())),r.querySelectorAll(":scope #dokuwiki__usertools li.user").forEach((e=>e.remove())),r.querySelectorAll(":scope #dokuwiki__usertools li.action.profile").forEach((e=>e.remove())),r.querySelectorAll("a").forEach((e=>{e.hostname&&e.hostname!==window.location.hostname&&e.setAttribute("target","_blank")}));const t=r.querySelector("div.preview");t&&(t.querySelectorAll('a[class^="wikilink"]').forEach((e=>{e.addEventListener("click",(function(e){if(!e.target)return;e.stopPropagation(),e.preventDefault();const r=e.target.getAttribute("href").replace(/^\/[^?]+\?id=(.*)$/,"$1");n({title:(0,l.Tl)(o.J,'Link to wiki page "{href}"',{href:r}),text:(0,l.Tl)(o.J,"Links to wiki pages are disabled in preview mode.")})}),!0)})),t.querySelectorAll('a[class^="media"]').forEach((e=>{e.addEventListener("click",(function(e){if(!e.target)return;e.stopPropagation(),e.preventDefault();const r=e.target.getAttribute("href").replace(/^\/[^?]+\?id=(.*)$/,"$1");n({title:(0,l.Tl)(o.J,'Link to wiki page "{href}"',{href:r}),text:(0,l.Tl)(o.J,"Links to media files are disabled in preview mode.")})}),!0)})))})(e)}catch(e){return f.error("UNABLE TO ACCESS IFRAME CONTENTS",{error:e}),void q(e)}u.fullScreen?F(S.value.getBoundingClientRect()):c(e),T=t?.body,f.debug("IFRAME BODY",{iFrameBody:T}),T&&L.observe(T),b.value.classList.toggle("fading",!0),f.debug("IFRAME IS NOW",{iFrame:e,location:r.location}),k.value=r.location.href;const a=r.location.search,s=r.location.pathname.replace(/^.*doku\.php\/?/,""),d=Object.fromEntries(new URLSearchParams(a).entries()),p=[];d.id?p.splice(0,0,...d.id.split(/:/)):p.splice(0,0,...s.split(/[:/]/)),i("iframe-loaded",{wikiPath:p,urlPath:s,query:d,iFrame:e,window:r,document:t}),v.value=!1},loadTimerHandler:x,appName:o.J}}});const f=(0,t(4486).A)(p,(function(){var e=this,r=e._self._c,t=e._self._setupProxy;return r("div",{ref:"container",class:t.appName+"-container"},[r("div",{ref:"loaderContainer",staticClass:"loader-container"}),e._v(" "),r("div",{ref:"frameWrapper",class:t.appName+"-frame-wrapper"},[r("iframe",e._b({ref:"externalFrame",attrs:{id:t.frameId,src:t.iFrameLocation,name:t.appName},on:{load:t.loadHandler}},"iframe",t.props.iFrameAttributes,!1))])])}),[],!1,null,"0fb51c06",null).exports}}]);
//# sourceMappingURL=src_DokuWikiWrapper_vue-6099b62788c1d330460b.js.map